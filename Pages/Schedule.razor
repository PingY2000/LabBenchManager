@*Pages\Schedule.razor*@
@page "/schedule/{BenchId:int}"
@attribute [Authorize(Roles = $"{AppRoles.TestEngineer},{AppRoles.Admin}")]

@using LabBenchManager.Models
@using LabBenchManager.Services
@using LabBenchManager.Components.Calendar
@using static LabBenchManager.Components.Calendar.CalendarHeader

@inject BenchService BenchSvc
@inject TestPlanService PlanSvc
@inject NavigationManager NavigationManager

<PageTitle>@benchName - 使用规划</PageTitle>

<!-- 页面头部 -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3>
            @*
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoBack">
                <span class="oi oi-chevron-left"></span>
            </button>*@
            🗓️ @benchName - 使用规划
        </h3>
        @if (currentBench != null)
        {
            <p class="text-muted mb-0">
                <span class="oi oi-map-marker me-1"></span>@currentBench.Location 
				@*<span class="badge @GetStatusBadgeClass(currentBenchStatus)">@currentBenchStatus</span>*@
            </p>
        }
    </div>
    <button class="btn btn-success" @onclick="AddNewPlan">
        <span class="oi oi-plus me-1"></span>添加测试计划
    </button>
</div>

@if (currentBench == null)
{
    <div class="alert alert-warning">
        <span class="oi oi-warning me-2"></span>未找到该设备信息
    </div>
}
else
{
    <!-- 左右分栏布局 -->
    <div class="row">
        <!-- 左侧：日历视图  -->
        <div class="col-12 col-md-6 col-lg-7 mb-3">
            <div class="card shadow-sm">
                <CalendarHeader Title="@GetCurrentPeriodTitle()"
                                CurrentView="@currentView"
                                OnPrevious="Previous"
                                OnNext="Next"
                                OnToday="GoToToday"
                                OnViewChange="HandleViewChange" />

                <div class="card-body p-0">
                    @if (currentView == CalendarViewType.Day)
                    {
                        <DayView CurrentDate="@currentDate"
                                 Plans="@testPlans"
                                 OnTimeSlotClick="AddPlanAtTime"
                                 OnPlanClick="EditPlan" />
                    }
                    else if (currentView == CalendarViewType.Month)
                    {
                        <MonthView CurrentDate="@currentDate"
                                   Plans="@testPlans"
                                   OnDayClick="OnDayClick"
                                   OnPlanClick="EditPlan" />
                    }
                    else if (currentView == CalendarViewType.Year)
                    {
                        <YearView CurrentDate="@currentDate"
                                  Plans="@testPlans"
                                  OnMonthClick="OnMonthClick" />
                    }
                </div>
            </div>
        </div>

        <!-- 右侧：测试计划列表  -->
        <div class="col-12 col-md-6 col-lg-5">
            <div class="card shadow-sm sticky-top" style="top: 1rem;">
                @if (pendingAssignments != null && pendingAssignments.Any())
                {
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">⌛ 待创建计划的申请</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        @foreach (var assignment in pendingAssignments)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">@assignment.ProjectName</h6>
                                        <small class="text-muted">
                                            <span class="oi oi-person me-1"></span>@assignment.ApplicantName
                                        </small>
                                    </div>
                                    <button class="btn btn-sm btn-primary" @onclick="() => CreatePlanFromAssignment(assignment)">
                                        <span class="oi oi-plus me-1"></span>创建计划
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">📋 测试计划</h5>
                </div>
                <div class="card-body p-0" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                    @if (testPlans == null || !testPlans.Any())
                    {
                        <div class="p-4 text-center text-muted">
                            <span class="oi oi-document" style="font-size: 3rem; opacity: 0.3;"></span>
                            <p class="mt-2">暂无测试计划</p>
                            <button class="btn btn-sm btn-primary" @onclick="AddNewPlan">
                                <span class="oi oi-plus me-1"></span>添加计划
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var plan in testPlans.OrderBy(p => p.Priority).ThenBy(p => p.PlannedStartTime))
                            {
                                <div class="list-group-item list-group-item-action @GetPlanListClass(plan)"
                                     @onclick="() => EditPlan(plan)"
                                     style="cursor: pointer;">
                                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <span class="badge @GetPriorityBadge(plan.Priority) me-1">
                                                @plan.Priority
                                            </span>
                                            <span class="badge @GetStatusBadge(plan.Status)">
                                                @plan.Status
                                            </span>
                                        </div>
                                        <div class="btn-group btn-group-sm" @onclick:stopPropagation="true">
                                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => EditPlan(plan)" title="编辑">
                                                <span class="oi oi-pencil"></span>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => ConfirmDeletePlan(plan)" title="删除">
                                                <span class="oi oi-trash"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <h6 class="mb-1">@plan.ProjectName</h6>
                                    <small class="text-muted">
                                        <div class="mb-1">
                                            <span class="oi oi-person me-1"></span>@(plan.AssignedTo ?? "未分配")
                                        </div>
                                        <div>
                                            <span class="oi oi-clock me-1"></span>
                                            @plan.PlannedStartTime?.ToString("MM-dd HH:mm") ~
                                            @plan.PlannedEndTime?.ToString("HH:mm")
                                        </div>
                                    </small>
                                    @if (!string.IsNullOrEmpty(plan.Description))
                                    {
                                        <div class="mt-2">
                                            <small class="text-muted">@plan.Description</small>
                                        </div>
                                    }
                                    <!-- 优先级调整按钮 -->
                                    <div class="mt-2 btn-group btn-group-sm" @onclick:stopPropagation="true">
                                        <button class="btn btn-outline-primary btn-sm" @onclick="() => ChangePriority(plan, -1)" title="提高优先级">
                                            <span class="oi oi-arrow-top"></span>
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" @onclick="() => ChangePriority(plan, 1)" title="降低优先级">
                                            <span class="oi oi-arrow-bottom"></span>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- 添加/编辑测试计划模态框 -->
@if (showPlanModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(editingPlan.Id == 0 ? "添加测试计划" : "编辑测试计划")
                    </h5>
                    <button type="button" class="btn-close" @onclick="ClosePlanModal"></button>
                </div>
                <EditForm Model="@editingPlan" OnValidSubmit="SavePlan">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">项目名称 <span class="text-danger">*</span></label>
                                <InputText class="form-control" @bind-Value="editingPlan.ProjectName" placeholder="请输入项目名称" />
                                <ValidationMessage For="@(() => editingPlan.ProjectName)" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">负责人 <span class="text-danger">*</span></label>
                                <InputText class="form-control" @bind-Value="editingPlan.AssignedTo" placeholder="请输入负责人" />
                                <ValidationMessage For="@(() => editingPlan.AssignedTo)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">优先级</label>
                                <InputSelect class="form-select" @bind-Value="editingPlan.Priority">
                                    @foreach (var priority in Enum.GetValues<PriorityLevel>())
                                    {
                                        <option value="@priority">@priority.ToString()</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">开始日期 <span class="text-danger">*</span></label>
                                <InputDate class="form-control" @bind-Value="startDate" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">开始时间</label>
                                <InputText type="time" class="form-control" @bind-Value="startTime" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">结束日期 <span class="text-danger">*</span></label>
                                <InputDate class="form-control" @bind-Value="endDate" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">结束时间</label>
                                <InputText type="time" class="form-control" @bind-Value="endTime" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">状态</label>
                                <InputSelect class="form-select" @bind-Value="editingPlan.Status">
                                    @foreach (var status in Enum.GetValues<TestPlanStatus>())
                                    {
                                        <option value="@status">@status.ToString()</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">备注说明</label>
                                <InputTextArea class="form-control" @bind-Value="editingPlan.Description" rows="4"
                                               placeholder="请输入测试相关的备注信息" />
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(validationError))
                        {
                            <div class="alert alert-danger">
                                <span class="oi oi-warning me-2"></span>@validationError
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="ClosePlanModal">取消</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="oi oi-check me-1"></span>保存
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<!-- 删除确认对话框 -->
@if (showDeleteConfirm)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除测试计划 <strong>@planToDelete?.ProjectName</strong> 吗？</p>
                    <p class="text-danger small">此操作无法撤销！</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">取消</button>
                    <button type="button" class="btn btn-danger" @onclick="ExecuteDelete">确认删除</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@inject AssignmentService AssignmentSvc

@code {
    [Parameter]
    public int BenchId { get; set; }

    private Bench? currentBench;
    private string benchName = "加载中...";
    private List<TestPlan>? testPlans;
    private CalendarViewType currentView = CalendarViewType.Month;
    private DateTime currentDate = DateTime.Today;
    private BenchStatus currentBenchStatus = BenchStatus.空闲;
    private List<Assignment>? pendingAssignments;

    // 删除确认
    private bool showDeleteConfirm = false;
    private TestPlan? planToDelete = null;

    // 添加/编辑计划
    private bool showPlanModal = false;
    private TestPlan editingPlan = new();
    private DateTime startDate = DateTime.Today;
    private DateTime endDate = DateTime.Today.AddDays(1);
    private string startTime = "09:00";
    private string endTime = "18:00";
    private string validationError = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        currentBench = await BenchSvc.GetByIdAsync(BenchId);
        benchName = currentBench?.Name ?? "未知设备";
        currentBenchStatus = await BenchSvc.GetBenchStatusAsync(BenchId);

        // 加载此测试台的所有测试计划
        var allPlans = await PlanSvc.GetAllPlansAsync();
        testPlans = allPlans.Where(p => p.BenchId == BenchId).ToList();

        // 新增：加载所有已分配到此测试台但尚未创建计划的申请
        var allAssignments = await AssignmentSvc.GetAllAsync();
        pendingAssignments = allAssignments
            .Where(a => a.BenchId == BenchId &&
                        a.Status == AssignmentStatus.未开始 &&
                        a.TestPlanId == null) // 确保还没有关联的计划
            .ToList();

        StateHasChanged(); // 确保UI更新
    }

    // ==================== 计划管理 ====================
    private void AddNewPlan()
    {
        editingPlan = new TestPlan
            {
                BenchId = BenchId,
                Priority = PriorityLevel.中,
                Status = TestPlanStatus.待开始
            };
        startDate = DateTime.Today;
        endDate = DateTime.Today.AddDays(1);
        startTime = "09:00";
        endTime = "18:00";
        validationError = "";
        showPlanModal = true;
    }

    private void AddPlanAtTime(DateTime time)
    {
        editingPlan = new TestPlan
            {
                BenchId = BenchId,
                Priority = PriorityLevel.中,
                Status = TestPlanStatus.待开始
            };
        startDate = time.Date;
        endDate = time.Date;
        startTime = time.ToString("HH:mm");
        endTime = time.AddHours(2).ToString("HH:mm");
        validationError = "";
        showPlanModal = true;
    }

    private void EditPlan(TestPlan plan)
    {
        editingPlan = new TestPlan
        {
            Id = plan.Id,
            BenchId = plan.BenchId,
            ProjectName = plan.ProjectName,
            AssignedTo = plan.AssignedTo,
            Priority = plan.Priority,
            Status = plan.Status,
            Description = plan.Description,
            PlannedStartTime = plan.PlannedStartTime,
            PlannedEndTime = plan.PlannedEndTime
        };

        if (plan.PlannedStartTime.HasValue)
        {
            startDate = plan.PlannedStartTime.Value.Date;
            startTime = plan.PlannedStartTime.Value.ToString("HH:mm");
        }

        if (plan.PlannedEndTime.HasValue)
        {
            endDate = plan.PlannedEndTime.Value.Date;
            endTime = plan.PlannedEndTime.Value.ToString("HH:mm");
        }

        validationError = "";
        showPlanModal = true;
    }

    private void CreatePlanFromAssignment(Assignment assignment)
    {
        editingPlan = new TestPlan
        {
            BenchId = BenchId,
            AssignmentId = assignment.Id, // 关键：关联Assignment ID
            ProjectName = assignment.ProjectName,
            Description = assignment.TestContent, // 使用测试内容作为描述
            AssignedTo = "", // 留空让用户填写
            RequestedBy = assignment.ApplicantName,
            SampleNumber = assignment.SampleBatchNo,
            SampleQuantity = assignment.SampleQuantity,
            Priority = assignment.IsUrgent ? PriorityLevel.紧急 : PriorityLevel.中,
            Status = TestPlanStatus.待开始
        };

        // 使用申请中期望的时间作为默认值
        startDate = assignment.EstimatedSampleTime.Date;
        startTime = "09:00"; // 或者使用一个默认时间
        endDate = assignment.DesiredCompletionTime.Date;
        endTime = "18:00";

        validationError = "";
        showPlanModal = true;
    }

    private async Task SavePlan()
    {
        // 验证时间
        if (!TimeSpan.TryParse(startTime, out var startTimeSpan))
        {
            validationError = "开始时间格式不正确";
            return;
        }

        if (!TimeSpan.TryParse(endTime, out var endTimeSpan))
        {
            validationError = "结束时间格式不正确";
            return;
        }

        // 组合日期和时间
        editingPlan.PlannedStartTime = startDate.Date.Add(startTimeSpan);
        editingPlan.PlannedEndTime = endDate.Date.Add(endTimeSpan);

        // 验证结束时间必须晚于开始时间
        if (editingPlan.PlannedEndTime <= editingPlan.PlannedStartTime)
        {
            validationError = "结束时间必须晚于开始时间";
            return;
        }

        // 检查时间冲突
        var conflictingPlan = testPlans?.FirstOrDefault(p =>
            p.Id != editingPlan.Id &&
            p.PlannedStartTime < editingPlan.PlannedEndTime &&
            p.PlannedEndTime > editingPlan.PlannedStartTime);

        if (conflictingPlan != null)
        {
            validationError = $"时间与现有计划 '{conflictingPlan.ProjectName}' 冲突";
            return;
        }

        try
        {
            if (editingPlan.Id == 0)
            {
                await PlanSvc.AddAsync(editingPlan);
            }
            else
            {
                await PlanSvc.UpdateAsync(editingPlan);
            }
            // 如果此计划是从一个申请创建的，则更新该申请
            if (editingPlan.AssignmentId.HasValue)
            {
                var relatedAssignment = await AssignmentSvc.GetByIdAsync(editingPlan.AssignmentId.Value);
                if (relatedAssignment != null)
                {
                    relatedAssignment.TestPlanId = editingPlan.Id; // 相互关联
                    relatedAssignment.Status = AssignmentStatus.进行中; // 更新状态为进行中
                    await AssignmentSvc.UpdateAsync(relatedAssignment);
                }
            }
            showPlanModal = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            validationError = $"保存失败: {ex.Message}";
        }
    }

    private void ClosePlanModal()
    {
        showPlanModal = false;
        validationError = "";
    }

    // ==================== 删除管理 ====================
    private void ConfirmDeletePlan(TestPlan plan)
    {
        planToDelete = plan;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        planToDelete = null;
    }

    private async Task ExecuteDelete()
    {
        if (planToDelete != null)
        {
            await PlanSvc.DeleteAsync(planToDelete.Id);
            showDeleteConfirm = false;
            planToDelete = null;
            await LoadData();
        }
    }

    private async Task ChangePriority(TestPlan plan, int delta)
    {
        var newPriority = (int)plan.Priority + delta;
        if (newPriority >= 1 && newPriority <= 4)
        {
            await PlanSvc.UpdatePriorityAsync(plan.Id, (PriorityLevel)newPriority);
            await LoadData();
        }
    }

    // ==================== 视图导航 ====================
    private string GetCurrentPeriodTitle() => currentView switch
    {
        CalendarViewType.Day => currentDate.ToString("yyyy年MM月dd日 dddd", new System.Globalization.CultureInfo("zh-CN")),
        CalendarViewType.Month => currentDate.ToString("yyyy年MM月"),
        CalendarViewType.Year => currentDate.ToString("yyyy年"),
        _ => ""
    };

    private void HandleViewChange(CalendarViewType newView)
    {
        currentView = newView;
    }

    private void Previous()
    {
        currentDate = currentView switch
        {
            CalendarViewType.Day => currentDate.AddDays(-1),
            CalendarViewType.Month => currentDate.AddMonths(-1),
            CalendarViewType.Year => currentDate.AddYears(-1),
            _ => currentDate
        };
    }

    private void Next()
    {
        currentDate = currentView switch
        {
            CalendarViewType.Day => currentDate.AddDays(1),
            CalendarViewType.Month => currentDate.AddMonths(1),
            CalendarViewType.Year => currentDate.AddYears(1),
            _ => currentDate
        };
    }

    private void GoToToday()
    {
        currentDate = DateTime.Today;
    }

    private void OnDayClick(DateTime date)
    {
        currentDate = date;
        currentView = CalendarViewType.Day;
    }

    private void OnMonthClick(DateTime monthDate)
    {
        currentDate = monthDate;
        currentView = CalendarViewType.Month;
    }

    private void GoBack() => NavigationManager.NavigateTo("/");
    // ==================== 样式辅助方法 ====================
    private string GetPlanListClass(TestPlan plan) => plan.Status switch
    {
        TestPlanStatus.进行中 => "border-start border-warning border-4",
        TestPlanStatus.已完成 => "bg-light",
        _ => ""
    };

    private string GetStatusBadgeClass(BenchStatus status) => status switch
    {
        BenchStatus.空闲 => "bg-success",
        BenchStatus.使用中 => "bg-warning text-dark",
        BenchStatus.维护中 => "bg-danger",
        BenchStatus.已预定 => "bg-info text-dark",
        _ => "bg-secondary"
    };

    private string GetPriorityBadge(PriorityLevel priority) => priority switch
    {
        PriorityLevel.紧急 => "bg-danger",
        PriorityLevel.高 => "bg-warning text-dark",
        PriorityLevel.中 => "bg-info text-dark",
        PriorityLevel.低 => "bg-secondary",
        _ => "bg-secondary"
    };

    private string GetStatusBadge(TestPlanStatus status) => status switch
    {
        TestPlanStatus.待开始 => "bg-secondary",
        TestPlanStatus.进行中 => "bg-primary",
        TestPlanStatus.已完成 => "bg-success",
        TestPlanStatus.已暂停 => "bg-warning text-dark",
        _ => "bg-dark"
    };
}