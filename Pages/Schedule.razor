@page "/schedule/{BenchId:int}"
@attribute [Authorize(Roles = $"{AppRoles.TestEngineer},{AppRoles.Admin}")]

@using System.Globalization
@using LabBenchManager.Models
@using LabBenchManager.Services
@using LabBenchManager.Components
@using LabBenchManager.Components.Calendar
@using static LabBenchManager.Components.Calendar.CalendarHeader

@inject BenchService BenchSvc
@inject TestPlanService PlanSvc
@inject AssignmentService AssignmentSvc
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime // 用于删除确认

<PageTitle>@benchName - 使用规划</PageTitle>

<!-- 页面头部 -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3>🗓️ @benchName - 使用规划</h3>
        @if (currentBench != null)
        {
            <p class="text-muted mb-0"><span class="oi oi-map-marker me-1"></span>@currentBench.Location</p>
        }
    </div>
    <!-- "添加"按钮现在会切换右侧面板的视图 -->
    <button class="btn btn-success" @onclick="AddNewPlan" disabled="@isInEditMode">
        <span class="oi oi-plus me-1"></span>添加测试计划
    </button>
</div>

@if (currentBench == null)
{
    <div class="alert alert-warning"><span class="oi oi-warning me-2"></span>未找到该设备信息</div>
}
else
{
    <div class="row">
        <!-- 左侧：日历视图  -->
        <div class="col-12 col-lg-7 mb-3">
            <div class="card shadow-sm">
                <CalendarHeader Title="@currentDate.ToString("yyyy年MM月")"
                                OnPrevious="Previous"
                                OnNext="Next"
                                OnToday="GoToToday" />
                <div class="card-body p-0">
                    <MonthView CurrentDate="@currentDate"
                               Plans="@testPlans"
                               SelectedDatesForPlan="@selectedDatesForEditing"
                               OnDayClick="HandleDayClick"
                               OnPlanClick="EditPlan" />
                </div>
            </div>
        </div>

        <!-- 右侧：动态面板 (计划列表 或 编辑表单) -->
        <div class="col-12 col-lg-5">
            <div class="sticky-top" style="top: 1rem;">
                
                @if (isInEditMode)
                {
                    <!-- ==================== 编辑/添加表单 ==================== -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                @(editingPlan.Id == 0 ? "添加新计划" : $"编辑计划: {editingPlan.ProjectName}")
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 150px); overflow-y: auto;">
                            <!-- 编辑表单内容保持不变 -->
                            <EditForm Model="@editingPlan" OnValidSubmit="SavePlan">
                                <DataAnnotationsValidator />
                                <div class="alert alert-info small p-2 mb-3"><span class="oi oi-info me-2"></span>请在左侧日历上点选日期。</div>
                                
                                <div class="mb-3">
                                    <label class="form-label">项目名称 <span class="text-danger">*</span></label>
                                    <InputText class="form-control" @bind-Value="editingPlan.ProjectName" />
                                    <ValidationMessage For="@(() => editingPlan.ProjectName)" />
                                </div>
                                
                                <!-- 状态下拉框现在使用新的枚举 -->
                                <div class="mb-3">
                                    <label class="form-label">状态</label>
                                    <InputSelect class="form-select" @bind-Value="editingPlan.Status">
                                        @foreach (var status in Enum.GetValues<TestPlanStatus>())
                                        {
                                            <option value="@status">@status.ToString()</option>
                                        }
                                    </InputSelect>
                                </div>
                            <div class="mb-3">
                                <label class="form-label">负责人</label>
                                <InputText class="form-control" @bind-Value="editingPlan.AssignedTo" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">已选日期 (@selectedDatesForEditing.Count)</label>
                                <div class="p-2 bg-light rounded" style="min-height: 40px;">
                                    @if (!selectedDatesForEditing.Any())
                                    {
                                        <span class="text-muted small">尚未选择</span>
                                    }
                                    else
                                    {
                                        @foreach (var date in selectedDatesForEditing.OrderBy(d => d))
                                        {
                                            <span class="badge bg-success me-1 mb-1">@date.ToString("MM-dd")</span>
                                        }
                                    }
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">状态</label>
                                <InputSelect class="form-select" @bind-Value="editingPlan.Status">
                                    @foreach (var status in Enum.GetValues<TestPlanStatus>())
                                    {
                                        <option value="@status">@status.ToString()</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注说明</label>
                                <InputTextArea class="form-control" @bind-Value="editingPlan.Description" rows="2" />
                            </div>

                            @if (!string.IsNullOrEmpty(validationError))
                            {
                                <div class="alert alert-danger small p-2"><span class="oi oi-warning me-2"></span>@validationError</div>
                            }
                        </EditForm>
                    </div>
                        <div class="card-footer text-end">
                            <button type="button" class="btn btn-secondary" @onclick="CancelEdit">取消</button>
                            <button type="button" class="btn btn-primary" @onclick="SavePlan"><span class="oi oi-check me-1"></span>保存</button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- ==================== 计划看板 ==================== -->
                    <div class="d-flex flex-column gap-3">

                        <!-- 1. 待创建计划的申请 -->
                        @if (pendingAssignments != null && pendingAssignments.Any())
                        {
                            <div class="card shadow-sm">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">⌛ 待创建计划的申请 (@pendingAssignments.Count)</h6>
                                </div>
                                <div class="list-group list-group-flush">
                                    @foreach (var assignment in pendingAssignments)
                                    {
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="fw-bold">@assignment.ProjectName</div>
                                                    <small class="text-muted"><span class="oi oi-person me-1"></span>@assignment.ApplicantName</small>
                                                </div>
                                                <button class="btn btn-sm btn-primary" @onclick="() => CreatePlanFromAssignment(assignment)"><span class="oi oi-plus me-1"></span>创建</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        
                        <!-- 2. 初步规划 -->
                        <PlanColumn Title="📝 初步规划"
                                    Status="TestPlanStatus.初步规划"
                                    Plans="testPlans"
                                    OnEdit="EditPlan"
                                    OnDelete="ConfirmDeletePlan" />
                                    
                        <!-- 3. 确定计划 -->
                        <PlanColumn Title="📅 确定计划"
                                    Status="TestPlanStatus.确定计划"
                                    Plans="testPlans"
                                    OnEdit="EditPlan"
                                    OnDelete="ConfirmDeletePlan" />

                        <!-- 4. 已完成 -->
                        <PlanColumn Title="✅ 已完成"
                                    Status="TestPlanStatus.已完成"
                                    Plans="testPlans"
                                    IsInitiallyCollapsed="true"
                                    OnEdit="EditPlan"
                                    OnDelete="ConfirmDeletePlan" />
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int BenchId { get; set; }

    private Bench? currentBench;
    private string benchName = "加载中...";
    private List<TestPlan>? testPlans;
    private DateTime currentDate = DateTime.Today;
    private List<Assignment>? pendingAssignments;

    private bool isInEditMode = false;
    private TestPlan editingPlan = new();
    private List<DateTime> selectedDatesForEditing = new();
    private string validationError = "";

    protected override async Task OnInitializedAsync() => await LoadData();
    protected override async Task OnParametersSetAsync() => await LoadData();

    private async Task LoadData()
    {
        currentBench = await BenchSvc.GetByIdAsync(BenchId);
        benchName = currentBench?.Name ?? "未知设备";
        testPlans = await PlanSvc.GetPlansByBenchIdAsync(BenchId);

        var allAssignments = await AssignmentSvc.GetAllAsync();
        pendingAssignments = allAssignments
            .Where(a => a.BenchId == BenchId && a.Status == AssignmentStatus.未开始 && a.TestPlanId == null)
            .ToList();

        StateHasChanged();
    }

    // --- 切换到编辑模式 ---
    private void EnterEditMode()
    {
        isInEditMode = true;
        validationError = "";
    }

    private void AddNewPlan()
    {
        // 默认状态为“初步规划”
        editingPlan = new TestPlan { BenchId = BenchId, Status = TestPlanStatus.初步规划 };
        selectedDatesForEditing.Clear();
        EnterEditMode();
    }

    private void EditPlan(TestPlan plan)
    {
        editingPlan = new TestPlan // 创建副本以支持“取消”
        {
            Id = plan.Id,
            BenchId = plan.BenchId,
            AssignmentId = plan.AssignmentId,
            ProjectName = plan.ProjectName,
            Description = plan.Description,
            Status = plan.Status,
            AssignedTo = plan.AssignedTo
        };
        selectedDatesForEditing = plan.GetScheduledDates();
        EnterEditMode();
    }

    private void CreatePlanFromAssignment(Assignment assignment)
    {
        editingPlan = new TestPlan
        {
            BenchId = BenchId,
            AssignmentId = assignment.Id,
            ProjectName = assignment.ProjectName,
            Description = assignment.TestContent,
            Status = TestPlanStatus.初步规划, // **默认状态为“初步规划”**
            RequestedBy = assignment.ApplicantName,
            SampleQuantity = assignment.SampleQuantity
        };
        selectedDatesForEditing = assignment.DesiredCompletionTime > DateTime.MinValue
                                  ? new List<DateTime> { assignment.DesiredCompletionTime.Date }
                                  : new List<DateTime>();
        EnterEditMode();
    }


    // --- 退出编辑模式 ---
    private void CancelEdit()
    {
        isInEditMode = false;
        editingPlan = new();
        selectedDatesForEditing.Clear();
    }

    // --- 保存逻辑 (已修正) ---
    private async Task SavePlan()
    {
        validationError = "";
        // ... 其他验证逻辑保持不变 ...

        try
        {
            TestPlan savedPlan;
            if (editingPlan.Id == 0) { await PlanSvc.AddAsync(editingPlan); savedPlan = editingPlan; }
            else { await PlanSvc.UpdateAsync(editingPlan); savedPlan = editingPlan; }

            // === 核心修正：根据计划状态更新申请状态 ===
            if (savedPlan.AssignmentId.HasValue)
            {
                var relatedAssignment = await AssignmentSvc.GetByIdAsync(savedPlan.AssignmentId.Value);
                if (relatedAssignment != null)
                {
                    relatedAssignment.TestPlanId = savedPlan.Id;

                    // 根据 TestPlan 的状态，映射到 Assignment 的状态
                    relatedAssignment.Status = savedPlan.Status switch
                    {
                        TestPlanStatus.初步规划 => AssignmentStatus.已规划,
                        TestPlanStatus.确定计划 => AssignmentStatus.已确定,
                        TestPlanStatus.已完成 => AssignmentStatus.已完成,
                        _ => relatedAssignment.Status // 保持不变
                    };

                    await AssignmentSvc.UpdateAsync(relatedAssignment);
                }
            }

            CancelEdit();
            await LoadData();
        }
        catch (Exception ex) { validationError = $"保存失败: {ex.Message}"; }
    }

    // --- 日历交互 (保持不变) ---
    private void HandleDayClick(DateTime date)
    {
        if (isInEditMode)
        {
            ToggleDateSelection(date);
        }
    }

    private void ToggleDateSelection(DateTime date)
    {
        if (date.Month != currentDate.Month) return;
        var isBookedByOther = testPlans?.Any(p => p.Id != editingPlan.Id && p.GetScheduledDates().Contains(date.Date)) ?? false;
        if (isBookedByOther) return;

        if (selectedDatesForEditing.Contains(date.Date))
        {
            selectedDatesForEditing.Remove(date.Date);
        }
        else
        {
            selectedDatesForEditing.Add(date.Date);
        }
    }

    // --- 删除逻辑 (保持不变) ---
    private async Task ConfirmDeletePlan(TestPlan plan)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"确定要删除计划 '{plan.ProjectName}' 吗？");
        if (confirmed)
        {
            await PlanSvc.DeleteAsync(plan.Id);
            await LoadData();
        }
    }

    // --- 导航和辅助方法 (保持不变) ---
    private void Previous() => currentDate = currentDate.AddMonths(-1);
    private void Next() => currentDate = currentDate.AddMonths(1);
    private void GoToToday() => currentDate = DateTime.Today;
    private string GetPlanListClass(TestPlan plan) => plan.Status == TestPlanStatus.初步规划 ? "border-start border-primary border-4" : "";
    private string GetStatusBadge(TestPlanStatus status) => status switch
    {
        TestPlanStatus.初步规划 => "bg-secondary",
        TestPlanStatus.确定计划 => "bg-primary",
        TestPlanStatus.已完成 => "bg-success",
        _ => "bg-dark"
    };
}