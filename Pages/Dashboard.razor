@page "/"
@page "/dashboard"

@using LabBenchManager.Services
@using LabBenchManager.Models
@inject BenchService BenchSvc
@inject NavigationManager NavigationManager

<PageTitle>设备状态总览</PageTitle>

<<<<<<< HEAD
<h3>设备状态总览 </h3>
=======
<h3>设备状态总览 (Dashboard)</h3>
>>>>>>> tfs/main
<p class="text-muted">实时查看所有测试台的当前状态。</p>

@if (benchesWithStatus == null)
{
    <p><em>正在从数据库加载设备列表...</em></p>
}
else if (benchesWithStatus.Count == 0)
{
    <div class="alert alert-info">
        数据库中还没有任何设备信息。请先到 <a href="/benches">设备管理</a> 页面添加设备。
    </div>
}
else
{0
    <div class="row row-cols-1 row-cols-lg-2 g-3">
        @foreach (var item in benchesWithStatus)
        {
            var bench = item.Bench;
            var status = item.Status;
            var docCount = benchDocuments.ContainsKey(bench.Id) ? benchDocuments[bench.Id].Count : 0;

            <div class="col">
                <div class="card h-100 @GetStatusClass(status)">
                    <div class="row g-0 h-100">
                        <div class="col-5">
                            @if (!string.IsNullOrEmpty(bench.PictureUrl))
                            {
                                <img src="@bench.PictureUrl" class="img-aspect-4-3 rounded-start" alt="@bench.Name">
                            }
                            else
                            {
                                <div class="placeholder-aspect-4-3 rounded-start">
                                    <span class="fs-3 oi oi-image"></span>
                                </div>
                            }
                        </div>
                        <div class="col-7">
                            <div class="card-body d-flex flex-column h-100 p-2 p-sm-3">
                                <div>
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="card-title mb-1">@bench.Name</h6>
                                    </div>
                                    <p class="card-subtitle mb-2 text-muted small">
                                        @if (!string.IsNullOrEmpty(bench.EquipmentNo))
                                        {
                                            <span>设备号: @bench.EquipmentNo</span>
                                        }
                                        @if (!string.IsNullOrEmpty(bench.AssetNo))
                                        {
                                            <span class="ms-2">资产号: @bench.AssetNo</span>
                                        }
                                    </p>
                                    <hr class="my-2" />
                                </div>

                                <ul class="list-unstyled small mb-2">
                                    <li><strong>测试类型:</strong> @(bench.TestType ?? "N/A")</li>
                                    <li><strong>测试对象:</strong> @(bench.TestObject ?? "N/A")</li>
                                    <li class="pt-1"><strong><span class="oi oi-map-marker me-1"></span>位置:</strong> @(bench.Location ?? "未指定")</li>
                                    
                                </ul>

                                <div class="mt-auto">
                                    <!-- 使用 d-flex 让内部元素水平排列 -->
                                    <div class="d-flex gap-2">
                                        
                                        <!-- flex-grow-1 让这个按钮也占据可用空间 -->
                                        <button class="btn btn-primary btn-sm flex-grow-1" @onclick="() => ViewSchedule(bench.Id)">
                                            <span class="oi oi-calendar me-1"></span>查看排产日历
                                        </button>
                                        @if (docCount > -1)
                                        {
                                            <!-- flex-grow-1 让这个按钮占据可用空间 -->
                                            <button class="btn btn-outline-info btn-sm flex-grow-1" @onclick="() => ViewDocuments(bench)">
                                                <span class="oi oi-document me-1"></span>相关文档 (@docCount)
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@* 文档查看模态框 *@
@if (showDocumentModal)
{
    <div class="modal fade show" style="display:block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="oi oi-document me-2"></span>
                        相关文档 - @currentBench?.Name
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDocumentModal"></button>
                </div>
                <div class="modal-body">
                    @if (currentDocuments == null)
                    {
                        <p class="text-muted">加载中...</p>
                    }
                    else if (!currentDocuments.Any())
                    {
                        <div class="alert alert-info">
                            <span class="oi oi-info me-2"></span>
                            暂无相关文档
                        </div>
                    }
                    else
                    {
                        <div class="list-group">
                            @foreach (var doc in currentDocuments)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <span class="@GetFileIcon(doc.FileType) me-2"></span>
                                                @doc.FileName
                                            </h6>
                                            @if (!string.IsNullOrEmpty(doc.Description))
                                            {
                                                <p class="mb-1 text-muted small">@doc.Description</p>
                                            }
                                            <small class="text-muted">
                                                <span class="me-3">
                                                    <span class="oi oi-data-transfer-download me-1"></span>
                                                    @FormatFileSize(doc.FileSize)
                                                </span>
                                                <span class="me-3">
                                                    <span class="oi oi-clock me-1"></span>
                                                    @doc.UploadedAt.ToString("yyyy-MM-dd HH:mm")
                                                </span>
                                                @*
                                                @if (!string.IsNullOrEmpty(doc.UploadedBy))
                                                {
                                                    <span>
                                                        <span class="oi oi-person me-1"></span>
                                                        @doc.UploadedBy
                                                    </span>
                                                }*@
                                            </small>
                                        </div>
                                        <div class="ms-3">
                                            <a href="@doc.FilePath" class="btn btn-primary btn-sm" download title="下载">
                                                <span class="oi oi-data-transfer-download"></span> 下载
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDocumentModal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<style>
    /* 卡片边框加粗显示状态 */
    .card {
        border-width: 2px;
    }

    /* 确保图片容器有固定高度 */
    .img-aspect-4-3 {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--bs-border-radius) 0 0 var(--bs-border-radius);
    }

    /* 占位符样式 */
    .placeholder-aspect-4-3 {
        width: 100%;
        height: 100%;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        border-radius: var(--bs-border-radius) 0 0 var(--bs-border-radius);
    }

    /* 修复卡片主体高度 */
    .card-body {
        min-height: 150px;
    }

    /* 确保卡片行等高 */
    .row.g-0 {
        min-height: 150px;
    }
</style>

@code {
    private List<BenchWithStatus>? benchesWithStatus;
    private Dictionary<int, List<BenchDocument>> benchDocuments = new();

    // 文档查看相关
    private bool showDocumentModal = false;
    private Bench? currentBench = null;
    private List<BenchDocument>? currentDocuments = null;

    protected override async Task OnInitializedAsync()
    {
        benchesWithStatus = await BenchSvc.GetAllWithStatusAsync();
        await LoadAllDocuments();
    }

    private async Task LoadAllDocuments()
    {
        benchDocuments.Clear();
        if (benchesWithStatus != null)
        {
            foreach (var item in benchesWithStatus)
            {
                var docs = await BenchSvc.GetDocumentsByBenchIdAsync(item.Bench.Id);
                benchDocuments[item.Bench.Id] = docs;
            }
        }
    }

    private async Task ViewDocuments(Bench bench)
    {
        currentBench = bench;
        currentDocuments = await BenchSvc.GetDocumentsByBenchIdAsync(bench.Id);
        showDocumentModal = true;
    }

    private void CloseDocumentModal()
    {
        showDocumentModal = false;
        currentBench = null;
        currentDocuments = null;
    }

    private string GetStatusClass(BenchStatus status) => status switch
    {
        BenchStatus.空闲 => "border-success",
        BenchStatus.使用中 => "border-warning",
        BenchStatus.维护中 => "border-danger",
        BenchStatus.已预定 => "border-info",
        _ => "border-secondary"
    };

    private string GetStatusBadgeClass(BenchStatus status) => status switch
    {
        BenchStatus.空闲 => "bg-success",
        BenchStatus.使用中 => "bg-warning text-dark",
        BenchStatus.维护中 => "bg-danger",
        BenchStatus.已预定 => "bg-info text-dark",
        _ => "bg-secondary"
    };

    private void ViewSchedule(int benchId)
    {
        NavigationManager.NavigateTo($"/schedule/{benchId}");
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetFileIcon(string? fileType)
    {
        if (string.IsNullOrEmpty(fileType)) return "oi oi-file";

        return fileType.ToLower() switch
        {
            ".pdf" => "oi oi-file text-danger",
            ".doc" or ".docx" => "oi oi-file text-primary",
            ".xls" or ".xlsx" => "oi oi-spreadsheet text-success",
            ".ppt" or ".pptx" => "oi oi-file text-warning",
            ".zip" or ".rar" => "oi oi-zip text-secondary",
            ".txt" => "oi oi-document text-muted",
            _ => "oi oi-file"
        };
    }
}