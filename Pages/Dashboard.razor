@page "/"
@page "/dashboard"

@using LabBenchManager.Services
@using LabBenchManager.Models
@inject BenchService BenchSvc
@inject NavigationManager NavigationManager

<PageTitle>设备状态总览</PageTitle>

<h3>设备状态总览 (Dashboard)</h3>
<p class="text-muted">实时查看所有测试台的当前状态。</p>

@if (benchesWithStatus == null)
{
    <p><em>正在从数据库加载设备列表...</em></p>
}
else if (benchesWithStatus.Count == 0)
{
    <div class="alert alert-info">
        数据库中还没有任何设备信息。请先到 <a href="/benches">设备管理</a> 页面添加设备。
    </div>
}
else
{
    <div class="row row-cols-1 row-cols-lg-2 g-3">
        @foreach (var item in benchesWithStatus)
        {
            var bench = item.Bench;
            var status = item.Status;

            <div class="col">
                <div class="card h-100 @GetStatusClass(status)">
                    <div class="row g-0 h-100">
                        <div class="col-5">
                            @if (!string.IsNullOrEmpty(bench.PictureUrl))
                            {
                                <img src="@bench.PictureUrl" class="img-aspect-4-3 rounded-start" alt="@bench.Name">
                            }
                            else
                            {
                                <div class="placeholder-aspect-4-3 rounded-start">
                                    <span class="fs-3 oi oi-image"></span>
                                </div>
                            }
                        </div>
                        <div class="col-7">
                            <div class="card-body d-flex flex-column h-100 p-2 p-sm-3">
                                <div>
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="card-title mb-1">@bench.Name</h6>
                                        <span class="badge @GetStatusBadgeClass(status)">@status.ToString()</span>
                                    </div>
                                    <p class="card-subtitle mb-2 text-muted small">
                                        @if (!string.IsNullOrEmpty(bench.EquipmentNo))
                                        {
                                            <span>设备: #@bench.EquipmentNo</span>
                                        }
                                        @if (!string.IsNullOrEmpty(bench.AssetNo))
                                        {
                                            <span class="ms-2">资产: #@bench.AssetNo</span>
                                        }
                                    </p>
                                    <hr class="my-2" />
                                </div>

                                <ul class="list-unstyled small mb-2">
                                    <li><strong>测试类型:</strong> @(bench.TestType ?? "N/A")</li>
                                    <li><strong>测试对象:</strong> @(bench.TestObject ?? "N/A")</li>
                                    <li class="pt-1"><strong><span class="oi oi-map-marker me-1"></span>位置:</strong> @(bench.Location ?? "未指定")</li>
                                </ul>

                                <div class="mt-auto">
                                    <hr class="my-2" />
                                    <div class="small">
                                        <div><strong><span class="oi oi-person me-1"></span>使用者:</strong> @(bench.CurrentUser ?? "N/A")</div>
                                        <div><strong><span class="oi oi-timer me-1"></span>结束时间:</strong> @(bench.NextAvailableTime?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</div>
                                    </div>
                                    <!-- 添加查看排产按钮 -->
                                    <div class="mt-2">
                                        <button class="btn btn-primary btn-sm w-100" @onclick="() => ViewSchedule(bench.Id)">
                                            <span class="oi oi-calendar me-1"></span>查看排产日历
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    /* 确保图片容器有固定高度 */
    .img-aspect-4-3 {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--bs-border-radius) 0 0 var(--bs-border-radius);
    }

    /* 占位符样式 */
    .placeholder-aspect-4-3 {
        width: 100%;
        height: 100%;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        border-radius: var(--bs-border-radius) 0 0 var(--bs-border-radius);
    }

    /* 修复卡片主体高度 */
    .card-body {
        min-height: 180px;
    }

    /* 确保卡片行等高 */
    .row.g-0 {
        min-height: 180px;
    }

    /* 卡片边框加粗显示状态 */
    .card {
        border-width: 2px;
    }
</style>

@code {
    private List<BenchWithStatus>? benchesWithStatus;

    protected override async Task OnInitializedAsync()
    {
        benchesWithStatus = await BenchSvc.GetAllWithStatusAsync();
    }

    private string GetStatusClass(BenchStatus status) => status switch
    {
        BenchStatus.空闲 => "border-success",
        BenchStatus.使用中 => "border-warning",
        BenchStatus.维护中 => "border-danger",
        BenchStatus.已预定 => "border-info",
        _ => "border-secondary"
    };

    private string GetStatusBadgeClass(BenchStatus status) => status switch
    {
        BenchStatus.空闲 => "bg-success",
        BenchStatus.使用中 => "bg-warning text-dark",
        BenchStatus.维护中 => "bg-danger",
        BenchStatus.已预定 => "bg-info text-dark",
        _ => "bg-secondary"
    };

    private void ViewSchedule(int benchId)
    {
        NavigationManager.NavigateTo($"/schedule/{benchId}");
    }
}