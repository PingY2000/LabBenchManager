@page "/request"
@using System.ComponentModel.DataAnnotations
@using LabBenchManager.Services
@using LabBenchManager.Models
@inject AssignmentService AssignmentSvc
@inject BenchService BenchSvc
@inject NavigationManager NavigationManager

<PageTitle>申请测试</PageTitle>

<h3>申请测试 (Request)</h3>
<p class="text-muted">填写以下表单以申请使用测试台。</p>

@if (showSuccessMessage)
{
    <div class="alert alert-success" role="alert">
        申请提交成功！管理员将会尽快审批。 <a href="/assignments" class="alert-link">查看我的申请</a>.
    </div>
}

<EditForm Model="@newAssignment" OnValidSubmit="HandleValidSubmit" class="card card-body bg-light">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label for="applicantName" class="form-label">申请人姓名</label>
        <InputText id="applicantName" class="form-control" @bind-Value="newAssignment.ApplicantName" />
        <ValidationMessage For="@(() => newAssignment.ApplicantName)" />
    </div>

    <div class="mb-3">
        <label for="projectName" class="form-label">项目名称</label>
        <InputText id="projectName" class="form-control" @bind-Value="newAssignment.ProjectName" />
        <ValidationMessage For="@(() => newAssignment.ProjectName)" />
    </div>

    <div class="mb-3">
        <label for="testBench" class="form-label">选择测试台</label>
        <InputSelect id="testBench" class="form-select" @bind-Value="newAssignment.BenchId">
            <option value="0">--请选择一个设备--</option>
            @if (availableBenches != null)
            {
                @foreach (var bench in availableBenches)
                {
                    <option value="@bench.Id">@bench.Name (@bench.Status)</option>
                }
            }
        </InputSelect>
        <ValidationMessage For="@(() => newAssignment.BenchId)" />
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="startTime" class="form-label">计划开始时间</label>
            <InputDate id="startTime" class="form-control" @bind-Value="newAssignment.StartTime" />
            <ValidationMessage For="@(() => newAssignment.StartTime)" />
        </div>
        <div class="col-md-6 mb-3">
            <label for="endTime" class="form-label">计划结束时间</label>
            <InputDate id="endTime" class="form-control" @bind-Value="newAssignment.EndTime" />
            <ValidationMessage For="@(() => newAssignment.EndTime)" />
        </div>
    </div>

    <div class="mb-3">
        <label for="notes" class="form-label">备注</label>
        <InputTextArea id="notes" class="form-control" @bind-Value="newAssignment.Notes" />
    </div>

    <button type="submit" class="btn btn-primary">提交申请</button>
</EditForm>


@code {
    private Assignment newAssignment = new();
    private List<Bench>? availableBenches;
    private bool showSuccessMessage = false;

    protected override async Task OnInitializedAsync()
    {
        // 从数据库加载可用的设备列表
        availableBenches = await BenchSvc.GetAllAsync();
    }

    private async Task HandleValidSubmit()
    {
        // 设置提交时的默认值
        newAssignment.RequestTime = DateTime.UtcNow;
        newAssignment.Status = AssignmentStatus.待审批;

        // 调用服务，将数据保存到数据库
        await AssignmentSvc.AddAsync(newAssignment);

        showSuccessMessage = true;

        // 重置表单模型，以便用户可以进行下一次提交
        newAssignment = new();

        // (可选) 几秒后自动隐藏成功消息
        await Task.Delay(5000);
        showSuccessMessage = false;
        StateHasChanged();
    }
}