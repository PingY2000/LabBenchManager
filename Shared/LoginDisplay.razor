@* Shared/LoginDisplay.razor *@
@using Microsoft.AspNetCore.Components.Authorization
@using LabBenchManager.Models
@using LabBenchManager.Services
@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject UserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider

<AuthorizeView>
    <Authorized>
        <div class="d-flex align-items-center gap-2">
            <span class="oi oi-person" aria-hidden="true"></span>

            @* 🔥 使用 Service 方法，简化逻辑 *@
            <strong>@(currentUserDisplayName ?? UserService.GetUserName(context.User.Identity?.Name))</strong>

            @* 显示当前角色徽章 *@
            @if (context.User.IsInRole(AppRoles.Admin))
            {
                <span class="badge bg-danger">管理员</span>
            }
            else if (context.User.IsInRole(AppRoles.TestEngineer))
            {
                <span class="badge bg-primary">测试工程师</span>
            }
            else if (context.User.IsInRole(AppRoles.Requester))
            {
                <span class="badge bg-info">申请者</span>
            }
            else
            {
                <span class="badge bg-warning text-dark">无角色</span>
            }

            @* 开发环境：角色切换下拉框 *@
            @if (IsDevelopment)
            {
                <select class="form-select form-select-sm"
                        style="width: 180px;"
                        value="@GetCurrentRole(context)"
                        @onchange="OnRoleChange">
                    <option value="">-- 切换角色 --</option>
                    <option value="@AppRoles.Admin">管理员</option>
                    <option value="@AppRoles.TestEngineer">测试工程师</option>
                    <option value="@AppRoles.Requester">申请者</option>
                    <option value="None">移除角色</option>
                </select>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <span class="text-muted">
            <span class="oi oi-warning" aria-hidden="true"></span>
            未登录

            @if (IsDevelopment)
            {
                <button class="btn btn-sm btn-outline-primary ms-2" @onclick="DevLogin">
                    <span class="oi oi-account-login"></span> [Dev] 模拟登录
                </button>
            }
        </span>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool IsDevelopment => Configuration.GetValue<bool>("IsDevelopment");
    private string currentUserDisplayName = "用户"; // 🔥 设置默认值

    

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserDisplayName();
    }

    private async Task LoadCurrentUserDisplayName()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true && !string.IsNullOrEmpty(user.Identity.Name))
        {
            // 🔥 一步获取：有 DisplayName 返回 DisplayName，否则返回从 NT 账号提取的用户名
            currentUserDisplayName = await UserService.GetDisplayNameOrUserNameAsync(user.Identity.Name);
        }
    }

    // 🔥 移除 GetUserName 方法，使用 UserService.GetUserName

    private string GetCurrentRole(AuthenticationState context)
    {
        if (context.User.IsInRole(AppRoles.Admin)) return AppRoles.Admin;
        if (context.User.IsInRole(AppRoles.TestEngineer)) return AppRoles.TestEngineer;
        if (context.User.IsInRole(AppRoles.Requester)) return AppRoles.Requester;
        return "";
    }

    private void OnRoleChange(ChangeEventArgs e)
    {
        var selectedRole = e.Value?.ToString();
        if (string.IsNullOrEmpty(selectedRole) || selectedRole == "-- 切换角色 --") return;

        Navigation.NavigateTo($"/dev/switch-role?role={selectedRole}", forceLoad: true);
    }

    private void DevLogin()
    {
        Navigation.NavigateTo("/dev/login", forceLoad: true);
    }
}