@* Components/Calendar/MonthView.razor *@
@using LabBenchManager.Models

<div class="table-responsive">
    <table class="table table-bordered mb-0 month-view-table">
        <thead class="table-light">
            <tr>
                <!-- 表头保持不变 -->
                <th class="text-center">周一</th>
                <th class="text-center">周二</th>
                <th class="text-center">周三</th>
                <th class="text-center">周四</th>
                <th class="text-center">周五</th>
                <th class="text-center">周六</th>
                <th class="text-center">周日</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var week in GetWeeks())
            {
                <tr>
                    @foreach (var day in week)
                    {
                        var plansInDay = GetPlansForDay(day.Date);
                        // 传入了所有被占用的日期和当前选择的日期，以决定单元格样式
                        var cellClass = GetDayCellClass(day);

                        <td class="month-day-cell @cellClass" @onclick="() => OnDayClick.InvokeAsync(day.Date)">
                            <div class="month-day-number">
                                <span class="day-number-badge @(day.IsToday ? "today-badge" : "")">
                                    @day.Date.Day
                                </span>
                            </div>
                            @foreach (var plan in plansInDay.Take(2)) // 减少显示数量，为选中样式留出空间
                            {
                                <div class="plan-block plan-block-@plan.Status"
                                     @onclick:stopPropagation="true"
                                     @onclick="() => OnPlanClick.InvokeAsync(plan)"
                                     title="@plan.ProjectName">
                                    @plan.ProjectName
                                </div>
                            }
                            @if (plansInDay.Count > 2)
                            {
                                <div class="small text-muted">+@(plansInDay.Count - 2) 更多...</div>
                            }
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter] public DateTime CurrentDate { get; set; }
    [Parameter] public List<TestPlan>? Plans { get; set; }
    [Parameter] public EventCallback<DateTime> OnDayClick { get; set; }
    [Parameter] public EventCallback<TestPlan> OnPlanClick { get; set; }

    // 新增：接收当前正在编辑的计划所选择的日期
    [Parameter] public List<DateTime> SelectedDatesForPlan { get; set; } = new();

    private class DayInfo
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
    }

    private List<List<DayInfo>> GetWeeks()
    {
        // 此方法保持不变
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek + (int)DayOfWeek.Monday);
        if (startDate > firstDayOfMonth) startDate = startDate.AddDays(-7);

        var weeks = new List<List<DayInfo>>();
        var currentDate = startDate;

        for (int week = 0; week < 6; week++)
        {
            if (week > 0 && currentDate > lastDayOfMonth) break; // 修正循环退出条件

            var weekDays = new List<DayInfo>();
            for (int day = 0; day < 7; day++)
            {
                weekDays.Add(new DayInfo
                {
                    Date = currentDate,
                    IsCurrentMonth = currentDate.Month == CurrentDate.Month,
                    IsToday = currentDate.Date == DateTime.Today
                });
                currentDate = currentDate.AddDays(1);
            }
            weeks.Add(weekDays);
        }
        return weeks;
    }

    private List<TestPlan> GetPlansForDay(DateTime date)
    {
        if (Plans == null) return new List<TestPlan>();
        // 逻辑更新：检查某个计划是否包含这一天
        return Plans.Where(p => p.GetScheduledDates().Contains(date.Date))
                    .ToList();
    }

    // 核心更新：根据更多状态返回单元格样式
    private string GetDayCellClass(DayInfo day)
    {
        var classes = new List<string>();
        if (!day.IsCurrentMonth)
        {
            classes.Add("other-month");
        }
        else
        {
            if (day.IsToday)
            {
                classes.Add("today-cell");
            }
            // 如果这个日期被当前正在编辑的计划选中了
            if (SelectedDatesForPlan.Contains(day.Date))
            {
                classes.Add("selected-for-plan");
            }
            // 如果这个日期已经被其他计划预定
            else if (GetPlansForDay(day.Date).Any())
            {
                classes.Add("booked-day");
            }
        }
        return string.Join(" ", classes);
    }
}