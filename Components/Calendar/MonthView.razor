@* Components/Calendar/MonthView.razor *@
@using LabBenchManager.Models

<div class="table-responsive">
    <table class="table table-bordered mb-0 month-view-table">
        <thead class="table-light">
            <tr>
                <th class="text-center">周一</th>
                <th class="text-center">周二</th>
                <th class="text-center">周三</th>
                <th class="text-center">周四</th>
                <th class="text-center">周五</th>
                <th class="text-center">周六</th>
                <th class="text-center">周日</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var week in GetWeeks())
            {
                <tr>
                    @foreach (var day in week)
                    {
                        var plansInDay = GetPlansForDay(day.Date);
                        var cellClass = GetDayCellClass(day);

                        <td class="month-day-cell @cellClass" @onclick="() => OnDayClick.InvokeAsync(day.Date)">
                            <div class="month-day-number">
                                <span class="day-number-badge @(day.IsToday ? "today-badge" : "")">
                                    @day.Date.Day
                                </span>
                            </div>

                            <div class="plans-container plans-count-@Math.Min(plansInDay.Count, 3)">
                                @if (plansInDay.Count == 0)
                                {
                                    <!-- No plans -->
                                }
                                else if (plansInDay.Count == 1)
                                {
                                    <!-- 1个计划：占满整个空间 -->
                                    <div class="plan-block plan-block-full plan-block-@plansInDay[0].Status @(plansInDay[0].Id == HighlightedPlanId ? "plan-highlighted" : "")"
                                         @onclick:stopPropagation="true"
                                         @onclick="() => OnPlanClick.InvokeAsync(plansInDay[0])"
                                         title="@plansInDay[0].ProjectName">
                                        <span class="plan-text">@plansInDay[0].ProjectName</span>
                                    </div>
                                }
                                else if (plansInDay.Count == 2)
                                {
                                    <!-- 2个计划：上下平分 -->
                                    <div class="plan-block plan-block-half plan-block-@plansInDay[0].Status @(plansInDay[0].Id == HighlightedPlanId ? "plan-highlighted" : "")"
                                         @onclick:stopPropagation="true"
                                         @onclick="() => OnPlanClick.InvokeAsync(plansInDay[0])"
                                         title="@plansInDay[0].ProjectName">
                                        <span class="plan-text">@plansInDay[0].ProjectName</span>
                                    </div>
                                    <div class="plan-block plan-block-half plan-block-@plansInDay[1].Status @(plansInDay[1].Id == HighlightedPlanId ? "plan-highlighted" : "")"
                                         @onclick:stopPropagation="true"
                                         @onclick="() => OnPlanClick.InvokeAsync(plansInDay[1])"
                                         title="@plansInDay[1].ProjectName">
                                        <span class="plan-text">@plansInDay[1].ProjectName</span>
                                    </div>
                                }
                                else
                                {
                                    <!-- 3个或更多：显示第1个 + 更多按钮（上下平分） -->
                                    <div class="plan-block plan-block-half plan-block-@plansInDay[0].Status @(plansInDay[0].Id == HighlightedPlanId ? "plan-highlighted" : "")"
                                         @onclick:stopPropagation="true"
                                         @onclick="() => OnPlanClick.InvokeAsync(plansInDay[0])"
                                         title="@plansInDay[0].ProjectName">
                                        <span class="plan-text">@plansInDay[0].ProjectName</span>
                                    </div>
                                    <div class="plan-block plan-block-half plan-more"
                                         @onclick:stopPropagation="true"
                                         @onclick="() => ShowMorePlans(day.Date, plansInDay)"
                                         title="点击查看全部 @plansInDay.Count 个计划">
                                        <span class="plan-text">+@(plansInDay.Count - 1) 更多...</span>
                                    </div>
                                }
                            </div>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- 更多计划弹出框 -->
@if (showMorePlansModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1" @onclick="CloseMorePlansModal">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @selectedDate.ToString("yyyy年M月d日") 的测试计划
                        <span class="badge bg-primary ms-2">@selectedDayPlans.Count 个</span>
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseMorePlansModal"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        @foreach (var plan in selectedDayPlans)
                        {
                            <a href="javascript:void(0)"
                               class="list-group-item list-group-item-action @(plan.Id == HighlightedPlanId ? "active" : "")"
                               @onclick="() => HandlePlanClickInModal(plan)">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1">@plan.ProjectName</h6>
                                    <span class="badge @GetStatusBadgeClass(plan.Status)">@plan.Status</span>
                                </div>
                                @if (!string.IsNullOrEmpty(plan.Description))
                                {
                                    <p class="mb-1 small text-muted">@plan.Description</p>
                                }
                                @if (!string.IsNullOrEmpty(plan.AssignedTo))
                                {
                                    <small class="text-muted">负责人: @plan.AssignedTo</small>
                                }
                            </a>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseMorePlansModal">关闭</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public DateTime CurrentDate { get; set; }
    [Parameter] public List<TestPlan>? Plans { get; set; }
    [Parameter] public EventCallback<DateTime> OnDayClick { get; set; }
    [Parameter] public EventCallback<TestPlan> OnPlanClick { get; set; }
    [Parameter] public List<DateTime> SelectedDatesForPlan { get; set; } = new();
    [Parameter] public int? HighlightedPlanId { get; set; }

    private bool showMorePlansModal = false;
    private DateTime selectedDate;
    private List<TestPlan> selectedDayPlans = new();

    private class DayInfo
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
    }

    private void ShowMorePlans(DateTime date, List<TestPlan> plans)
    {
        selectedDate = date;
        selectedDayPlans = plans.OrderByDescending(p => p.Id).ToList(); // 最新的在前
        showMorePlansModal = true;
    }

    private void CloseMorePlansModal()
    {
        showMorePlansModal = false;
    }

    private async Task HandlePlanClickInModal(TestPlan plan)
    {
        await OnPlanClick.InvokeAsync(plan);
        CloseMorePlansModal();
    }

    private string GetStatusBadgeClass(TestPlanStatus status) => status switch
    {
        TestPlanStatus.初步规划 => "bg-secondary",
        TestPlanStatus.确定计划 => "bg-primary",
        TestPlanStatus.已完成 => "bg-success",
        _ => "bg-dark"
    };

    private List<List<DayInfo>> GetWeeks()
    {
        var firstDayOfMonth = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek + (int)DayOfWeek.Monday);
        if (startDate > firstDayOfMonth) startDate = startDate.AddDays(-7);

        var weeks = new List<List<DayInfo>>();
        var currentDate = startDate;

        for (int week = 0; week < 6; week++)
        {
            if (week > 0 && currentDate > lastDayOfMonth) break;

            var weekDays = new List<DayInfo>();
            for (int day = 0; day < 7; day++)
            {
                weekDays.Add(new DayInfo
                {
                    Date = currentDate,
                    IsCurrentMonth = currentDate.Month == CurrentDate.Month,
                    IsToday = currentDate.Date == DateTime.Today
                });
                currentDate = currentDate.AddDays(1);
            }
            weeks.Add(weekDays);
        }
        return weeks;
    }

    private List<TestPlan> GetPlansForDay(DateTime date)
    {
        if (Plans == null) return new List<TestPlan>();
        return Plans.Where(p => p.GetScheduledDates().Contains(date.Date))
                    .OrderByDescending(p => p.Id) // 最新的在前
                    .ToList();
    }

    private string GetDayCellClass(DayInfo day)
    {
        var classes = new List<string>();
        if (!day.IsCurrentMonth)
        {
            classes.Add("other-month");
        }
        else
        {
            if (day.IsToday)
            {
                classes.Add("today-cell");
            }
            if (SelectedDatesForPlan.Contains(day.Date))
            {
                classes.Add("selected-for-plan");
            }
            else if (GetPlansForDay(day.Date).Any())
            {
                classes.Add("has-plans");
            }
        }
        return string.Join(" ", classes);
    }
}