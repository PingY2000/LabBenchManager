@* Components/AssignmentDetailModal.razor *@
@using LabBenchManager.Models
@inject NavigationManager NavManager
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (Assignment != null && canView)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        申请详情 #@Assignment.Id
                        @if (Assignment.IsUrgent)
                        {
                            <span class="badge bg-danger ms-2">加急</span>
                        }
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => OnClose.InvokeAsync()"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">申请信息</h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">项目名称</label>
                                <div class="form-control-plaintext">@Assignment.ProjectName</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">申请人</label>
                                    <div class="form-control-plaintext">@Assignment.ApplicantName</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">部门/单位</label>
                                    <div class="form-control-plaintext">@Assignment.Department</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">申请时间</label>
                                    <div class="form-control-plaintext">@Assignment.RequestTime.ToString("yyyy-MM-dd HH:mm")</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">状态</label>
                                    <div>
                                        <span class="badge @GetStatusBadgeClass(Assignment.Status)">@Assignment.Status</span>
                                    </div>
                                </div>
                            </div>
                            @if (Assignment.BenchId.HasValue)
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">已分配设备</label>
                                    <div class="form-control-plaintext text-success">@Assignment.Bench?.Name</div>
                                </div>
                            }
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">样品信息</h6>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">样品数量</label>
                                    <div class="form-control-plaintext">@Assignment.SampleQuantity 个</div>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(Assignment.SampleSpecification))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">样品规格/型号</label>
                                    <div class="form-control-plaintext">@Assignment.SampleSpecification</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Assignment.SampleBatchNo))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">样品批号</label>
                                    <div class="form-control-plaintext">@Assignment.SampleBatchNo</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Assignment.SampleRequirements))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">样品特殊要求</label>
                                    <pre class="form-control-plaintext bg-light p-2 rounded small">@Assignment.SampleRequirements</pre>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">时间规划</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label fw-bold">预计交样时间</label>
                                    <div class="form-control-plaintext">@Assignment.EstimatedSampleTime.ToString("yyyy-MM-dd")</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">期望完成时间</label>
                                    <div class="form-control-plaintext">@Assignment.DesiredCompletionTime.ToString("yyyy-MM-dd")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">测试要求</h6>
                            <div class="mb-2">
                                <label class="form-label fw-bold">测试标准/依据</label>
                                <div class="form-control-plaintext">@(Assignment.TestStandard ?? "---")</div>
                            </div>
                            @if (!string.IsNullOrEmpty(Assignment.TestParameters))
                            {
                                <div class="mb-2">
                                    <label class="form-label fw-bold">测试参数/条件</label>
                                    <pre class="form-control-plaintext bg-light p-2 rounded small">@Assignment.TestParameters</pre>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6 class="text-muted border-bottom pb-2 mb-3">测试内容</h6>
                        <pre class="form-control-plaintext bg-light p-3 rounded">@Assignment.TestContent</pre>
                    </div>
                    @if (Assignment.TestPlan != null)
                    {
                        <div class="mt-4">
                            <h6 class="text-muted border-bottom pb-2 mb-3">
                                关联的测试计划 <button type="button" class="btn btn-sm btn-outline-info" @onclick="GoToSchedule">
                                    <span class="oi oi-calendar me-1"></span>转到日历
                                </button>
                            </h6>
                            <div class="row">
                                <div class="col-4">
                                    <label class="form-label fw-bold">负责人</label>
                                    <div class="form-control-plaintext">
                                        @(Assignment.TestPlan.AssignedTo ?? "未指定")
                                    </div>
                                </div>
                                <div class="col-4">
                                    <label class="form-label fw-bold">计划状态</label>
                                    <div class="form-control-plaintext">
                                        <span class="badge @GetPlanStatusBadgeClass(Assignment.TestPlan.Status)">
                                            @Assignment.TestPlan.Status.ToString()
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label fw-bold">已安排日期</label>
                                <div class="p-2 bg-light rounded border">
                                    @if (Assignment.TestPlan.ScheduledDateList?.Any() == true)
                                    {
                                        <span class="text-muted small">
                                            <span class="oi oi-calendar me-1"></span>
                                            @DateUtils.FormatDateListWithRanges(Assignment.TestPlan.ScheduledDateList)
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">暂未安排具体日期</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Assignment.SpecialRequirements))
                    {
                        <div class="mt-3">
                            <h6 class="text-muted border-bottom pb-2 mb-3">特殊要求</h6>
                            <pre class="form-control-plaintext bg-light p-3 rounded">@Assignment.SpecialRequirements</pre>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Assignment.UrgentReason))
                    {
                        <div class="mt-3">
                            <h6 class="text-muted border-bottom pb-2 mb-3">加急原因</h6>
                            <pre class="form-control-plaintext bg-warning-light p-3 rounded">@Assignment.UrgentReason</pre>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Assignment.Notes))
                    {
                        <div class="mt-3">
                            <h6 class="text-muted border-bottom pb-2 mb-3">备注说明</h6>
                            <pre class="form-control-plaintext bg-light p-3 rounded">@Assignment.Notes</pre>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (ShowActions)
                    {
                        @if (Assignment.Status == AssignmentStatus.待审批)
                        {
                            <button class="btn btn-success" @onclick="() => OnApprove.InvokeAsync(Assignment)">
                                <span class="oi oi-check me-1"></span>批准申请
                            </button>
                            <button class="btn btn-danger" @onclick="() => OnReject.InvokeAsync(Assignment)">
                                <span class="oi oi-x me-1"></span>拒绝申请
                            </button>
                        }
                        @if (Assignment.Status == AssignmentStatus.待分配)
                        {
                            <button class="btn btn-info" @onclick="() => OnGoToAllocate.InvokeAsync(Assignment)">
                                <span class="oi oi-fork me-1"></span>去分配
                            </button>
                        }
                    }
                    <button class="btn btn-secondary" @onclick="() => OnClose.InvokeAsync()">关闭</button>
                </div>
            </div>
        </div>
    </div>
}
else if (Assignment != null && !canView)
{
    @* 🔥 无权限提示模态框 - 柔和样式 *@
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light border-bottom">
                    <h5 class="modal-title text-secondary">
                        <span class="oi oi-lock-locked"></span> 无权限访问
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => OnClose.InvokeAsync()"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <h5 class="text-secondary">您没有权限查看此申请</h5>
                    <p class="text-muted small">
                        只有以下用户可以查看：
                    </p>
                    <ul class="list-unstyled">
                        <li class="mb-1"><span class="badge bg-secondary">管理员</span></li>
                        <li class="mb-1"><span class="badge bg-secondary">测试工程师</span></li>
                        <li class="mb-1"><span class="badge bg-secondary">申请发起人</span></li>
                    </ul>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" @onclick="() => OnClose.InvokeAsync()">关闭</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Assignment? Assignment { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public bool ShowActions { get; set; } = true;

    [Parameter]
    public EventCallback<Assignment> OnApprove { get; set; }

    [Parameter]
    public EventCallback<Assignment> OnReject { get; set; }

    [Parameter]
    public EventCallback<Assignment> OnGoToAllocate { get; set; }
    private bool canView = false;

    // 🔥 新增或替换 OnParametersSetAsync
    protected override async Task OnParametersSetAsync()
    {
        await CheckViewPermission();
    }

    // 🔥 新增权限检查方法
    private async Task CheckViewPermission()
    {
        if (Assignment == null)
        {
            canView = false;
            return;
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            canView = false;
            return;
        }

        var currentUserNTAccount = user.Identity?.Name;

        // 权限判断：管理员 OR 测试工程师 OR 申请发起人
        canView = user.IsInRole(AppRoles.Admin) ||
                  user.IsInRole(AppRoles.TestEngineer)||
              IsApplicant(currentUserNTAccount);
    }

    // 🔥 新增发起人判断方法
    private bool IsApplicant(string? currentUserNTAccount)
    {
        if (string.IsNullOrEmpty(currentUserNTAccount) || Assignment == null)
        {
            return false;
        }

        // 不区分大小写比较 NT 账号
        return string.Equals(
            Assignment.ApplicantNTAccount,
            currentUserNTAccount,
            StringComparison.OrdinalIgnoreCase
        );
    }
    private void GoToSchedule()
    {
        if (Assignment == null || !Assignment.BenchId.HasValue || !Assignment.TestPlanId.HasValue)
        {
            return;
        }

        if (Assignment.TestPlan == null) return;

        var firstDate = Assignment.TestPlan.GetScheduledDates().OrderBy(d => d).FirstOrDefault();

        var targetDate = firstDate == default ? DateTime.Today : firstDate;

        var url = $"/schedule/{Assignment.BenchId.Value}?initialDate={targetDate:yyyy-MM-dd}&highlightPlanId={Assignment.TestPlanId.Value}";

        NavManager.NavigateTo(url);
    }

    // Auxiliary method for plan status badge (add if not present)
    private string GetPlanStatusBadgeClass(TestPlanStatus status) => status switch
    {
        TestPlanStatus.初步规划 => "bg-secondary",
        TestPlanStatus.确定计划 => "bg-primary",
        TestPlanStatus.已完成 => "bg-success",
        _ => "bg-dark"
    };

    // 将辅助方法也移动到这里
    private string GetStatusBadgeClass(AssignmentStatus status) => status switch
    {
        AssignmentStatus.待审批 => "bg-warning text-dark",
        AssignmentStatus.待分配 => "bg-info text-white",
        AssignmentStatus.已拒绝 => "bg-danger",
        AssignmentStatus.未开始 => "bg-light text-dark",
        AssignmentStatus.已规划 => "bg-secondary",
        AssignmentStatus.已确定 => "bg-primary",   // “已确定”可以沿用之前“进行中”的醒目颜色
        AssignmentStatus.已完成 => "bg-success",
        _ => "bg-dark"
    };

}