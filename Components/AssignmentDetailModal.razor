@using LabBenchManager.Models

@if (Assignment != null)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        申请详情 #@Assignment.Id
                        @if (Assignment.IsUrgent)
                        {
                            <span class="badge bg-danger ms-2">加急</span>
                        }
                    </h5>
                    <button type="button" class="btn-close" @onclick="() => OnClose.InvokeAsync()"></button>
                </div>
                <div class="modal-body">
                    <!-- 模态框内容 (从原文件中完整复制) -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">申请信息</h6>
                            <div class="mb-3">
                                <label class="form-label fw-bold">项目名称</label>
                                <div class="form-control-plaintext">@Assignment.ProjectName</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">申请人</label>
                                    <div class="form-control-plaintext">@Assignment.ApplicantName</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">部门/单位</label>
                                    <div class="form-control-plaintext">@Assignment.Department</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">申请时间</label>
                                    <div class="form-control-plaintext">@Assignment.RequestTime.ToString("yyyy-MM-dd HH:mm")</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">状态</label>
                                    <div>
                                        <span class="badge @GetStatusBadgeClass(Assignment.Status)">@Assignment.Status</span>
                                    </div>
                                </div>
                            </div>
                            @if (Assignment.BenchId.HasValue)
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">已分配设备</label>
                                    <div class="form-control-plaintext text-success">@Assignment.Bench?.Name</div>
                                </div>
                            }
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">样品信息</h6>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">样品数量</label>
                                    <div class="form-control-plaintext">@Assignment.SampleQuantity 个</div>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(Assignment.SampleSpecification))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">样品规格/型号</label>
                                    <div class="form-control-plaintext">@Assignment.SampleSpecification</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Assignment.SampleBatchNo))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">样品批号</label>
                                    <div class="form-control-plaintext">@Assignment.SampleBatchNo</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(Assignment.SampleRequirements))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">样品特殊要求</label>
                                    <pre class="form-control-plaintext bg-light p-2 rounded small">@Assignment.SampleRequirements</pre>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">时间规划</h6>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label fw-bold">预计交样时间</label>
                                    <div class="form-control-plaintext">@Assignment.EstimatedSampleTime.ToString("yyyy-MM-dd")</div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">期望完成时间</label>
                                    <div class="form-control-plaintext">@Assignment.DesiredCompletionTime.ToString("yyyy-MM-dd")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted border-bottom pb-2 mb-3">测试要求</h6>
                            <div class="mb-2">
                                <label class="form-label fw-bold">测试标准/依据</label>
                                <div class="form-control-plaintext">@(Assignment.TestStandard ?? "---")</div>
                            </div>
                            @if (!string.IsNullOrEmpty(Assignment.TestParameters))
                            {
                                <div class="mb-2">
                                    <label class="form-label fw-bold">测试参数/条件</label>
                                    <pre class="form-control-plaintext bg-light p-2 rounded small">@Assignment.TestParameters</pre>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6 class="text-muted border-bottom pb-2 mb-3">测试内容</h6>
                        <pre class="form-control-plaintext bg-light p-3 rounded">@Assignment.TestContent</pre>
                    </div>

                    @if (!string.IsNullOrEmpty(Assignment.SpecialRequirements))
                    {
                        <div class="mt-3">
                            <h6 class="text-muted border-bottom pb-2 mb-3">特殊要求</h6>
                            <pre class="form-control-plaintext bg-light p-3 rounded">@Assignment.SpecialRequirements</pre>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Assignment.UrgentReason))
                    {
                        <div class="mt-3">
                            <h6 class="text-muted border-bottom pb-2 mb-3">加急原因</h6>
                            <pre class="form-control-plaintext bg-warning-light p-3 rounded">@Assignment.UrgentReason</pre>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Assignment.Notes))
                    {
                        <div class="mt-3">
                            <h6 class="text-muted border-bottom pb-2 mb-3">备注说明</h6>
                            <pre class="form-control-plaintext bg-light p-3 rounded">@Assignment.Notes</pre>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (Assignment.Status == AssignmentStatus.待审批)
                    {
                        <button class="btn btn-success" @onclick="() => OnApprove.InvokeAsync(Assignment)">
                            <span class="oi oi-check me-1"></span>批准申请
                        </button>
                        <button class="btn btn-danger" @onclick="() => OnReject.InvokeAsync(Assignment)">
                            <span class="oi oi-x me-1"></span>拒绝申请
                        </button>
                    }
                    @if (Assignment.Status == AssignmentStatus.待分配)
                    {
                        <button class="btn btn-info" @onclick="() => OnGoToAllocate.InvokeAsync(Assignment)">
                            <span class="oi oi-fork me-1"></span>去分配
                        </button>
                    }
                    <button class="btn btn-secondary" @onclick="() => OnClose.InvokeAsync()">关闭</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter]
    public Assignment? Assignment { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<Assignment> OnApprove { get; set; }

    [Parameter]
    public EventCallback<Assignment> OnReject { get; set; }

    [Parameter]
    public EventCallback<Assignment> OnGoToAllocate { get; set; }

    // 将辅助方法也移动到这里
    private string GetStatusBadgeClass(AssignmentStatus status) => status switch
    {
        AssignmentStatus.待审批 => "bg-warning text-dark",
        AssignmentStatus.待分配 => "bg-info text-white",
        AssignmentStatus.已拒绝 => "bg-danger",
        AssignmentStatus.未开始 => "bg-light text-dark",
        AssignmentStatus.已规划 => "bg-secondary",
        AssignmentStatus.已确定 => "bg-primary",   // “已确定”可以沿用之前“进行中”的醒目颜色
        AssignmentStatus.已完成 => "bg-success",
        _ => "bg-dark"
    };

}